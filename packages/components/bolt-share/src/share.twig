{% set schema = bolt.data.components["@bolt-components-share"].schema %}

{% if enable_json_schema_validation %}
  {{ validate_data_schema(schema, _self) | raw }}
{% endif %}

{% set copyToClipboard = copy_to_clipboard %}

{# Variables #}
{% set base_class = "c-bolt-share" %}
{% set attributes = create_attribute(attributes|default({})) %}
{% set inner_attributes = create_attribute({}) %}

{# Set up checks to validate that the component's prop values are allowed, based on the component's schema. #}
{% set size_options = schema.properties.size.enum %}
{% set opacity_options = schema.properties.opacity.enum %}

{# Check that the component's current prop values are valid. If not, default to the schema default #}
{% set size = size in size_options ? size : schema.properties.size.default %}
{% set opacity = opacity in opacity_options ? opacity : schema.properties.opacity.default %}
{% set inline = inline is sameas(true) or inline is sameas(false) ? inline : schema.properties.inline.default %}

{# Default text can't be pulled from the schema because it must be translatable. #}
{% set text = text | default("Share this page"|t) %}
{% if copy_to_clipboard %}
  {% set copy_to_clipboard_text = copy_to_clipboard.text | default("Copy share link"|t) %}
  {% set copy_to_clipboard_url = copy_to_clipboard.url %}
{% endif %}

{# Items #}
{% set items = [] %}

{% if inline %}
  {% set inline_label %}
    <span class="{{ "#{base_class}__label #{base_class}__label--#{size}" }}">{{ text }}</span>
  {% endset %}
  {% set items = items|merge([inline_label]) %}
{% endif %}

{% for source in sources %}
  {% set source_target = "_blank" %}

  {% if "facebook" == source.name %}
    {% set source_name = "Facebook"|t %}
    {% set source_icon = "facebook-solid" %}
  {% elseif "twitter" == source.name  %}
    {% set source_name = "Twitter"|t %}
    {% set source_icon = "twitter" %}
  {% elseif "linkedin" == source.name  %}
    {% set source_name = "LinkedIn"|t %}
    {% set source_icon = "linkedin" %}
  {% elseif "email" == source.name  %}
    {% set source_name = "Email"|t %}
    {% set source_icon = "email" %}
  {% else %}
    {% set source_name = false %}
  {% endif %}

  {% if source_name %}
    {% set source_items %}
      {% include "@bolt-components-link/link.twig" with {
        text: "<span class='c-bolt-share__link-text'>#{source_name}</span>",
        url: source.url,
        icon: {
          name: source_icon,
          position: "before",
          size: size
        },
        attributes: {
          class: [
            "c-bolt-share__link",
            "js-bolt-share__link--"~source.name,
          ],
          target: source_target
        }
      } only %}
    {% endset %}
    {% set items = items|merge([source_items]) %}
  {% endif %}
{% endfor %}

{% if copy_to_clipboard %}
  {% set copy_to_clipboard_include %}
    <div class="c-bolt-share__copy">
      {% include "@bolt-components-copy-to-clipboard/copy-to-clipboard.twig" with {
        text: "<span class='c-bolt-share__link-text'>#{copy_to_clipboard_text}</span>",
        url: copy_to_clipboard_url,
        iconSize: size,
        attributes: {
          class: "c-bolt-share__link"
        }
      } only %}
    </div>
  {% endset %}
  {% set items = items|merge([copy_to_clipboard_include]) %}
{% endif %}

{# Share component's custom element wrapper. #}
<bolt-share
  {% if inline %} inline {% endif %}
  {% if size %} size="{{ size }}" {% endif %}
  {% if opacity %} opacity="{{ opacity }}" {% endif %}
  {{ attributes }}
>
  {# Array of classes based on the defined + default props. #}
  {% set classes = [
    base_class,
    inline ? "#{base_class}--display-inline" : "#{base_class}--display-button",
    inline ? opacity in opacity_options ? "#{base_class}--opacity-#{opacity}" : "",
  ] %}

  <div {{ inner_attributes.addClass(classes) }}>
    {% if inline %}
      {% include "@bolt-components-list/list.twig" with {
        display: "inline",
        spacing: size == "small" ? "xsmall" : "small",
        items: items
      } only %}
    {% else %}
      {% include "@bolt-components-tooltip/tooltip.twig" with {
        trigger: {
          type: "button",
          text: text,
          transform: "uppercase",
          icon: {
            name: "share",
            size: "medium"
          },
          toggle: {
            text: "Close"|t,
            name: "close-solid"
          }
        },
        content: include ("@bolt-components-list/list.twig", {
          display: "block",
          spacing: "none",
          items: items
        }),
        position: "up",
        noWrap: true,
        spacing: "none",
        attributes: create_attribute(attributes|default({})).setAttribute("count",items|length)
      } only %}
    {% endif %}
  </div>
</bolt-share>
