{% set schema = bolt.data.components["@bolt-components-image"].schema %}

{% if enable_json_schema_validation %}
  {{ validate_data_schema(schema, _self) | raw }}
{% endif %}

{% set image_data_bolt = bolt.data.images[src] %} {# Data from Bolt Manifest #}
{% set image_data_twig = getImageData(src)  %} {# Data from processing image file #}

{% set display = display in display_options ? display : schema.properties.display.default %}
{% set height = height|default(image_data_twig.height) %}
{% set width = width|default(image_data_twig.width) %}
{% set lazyload = lazyload ?? true %}
{% set sizes = sizes|default("auto") %}
{% set srcset = srcset|default(src) %}

{% if image_data_bolt.srcset %}
  {% set srcset = image_data_bolt.srcset %}
{% endif %}

{# Set alt to null if missing, prevents empty alt tags #}
{% set alt = alt ? alt : null %}

{# Temp: prefix "ph" to preserve original value for web component, better pattern in the works #}
{% set ph_color = placeholder_color|default(image_data_twig.color|default(schema.properties.placeholder_color.default)) %}
{% set ph_image = placeholder_image|default(image_data_twig.base64|default(schema.properties.placeholder_image.default)) %}

{% set is_jpg = src|split('.')|last == "jpg" %}
{% set useAspectRatio = useAspectRatio ?? true %}
{% set can_use_ratio = width > 0 and height > 0 and useAspectRatio is sameas(true) and object is sameas(false) %}
{# Only JPGs allowed, PNGs can have transparency and may not look right layered over placeholder #}
{% set can_use_placeholder = can_use_ratio or cover %}

{#--------------------#}
{# STOP!!!!!!!!!#}
{# The ONLY thing that can happen below here is creating and building the `attributes`, then calling the template - ALL data must be prepped by this point #}
{#--------------------#}

{% set attributes = create_attribute(attributes | default({})) %}

{% set image_classes = [
  "c-bolt-image__image"
] %}

{% set placeholder_classes = [
  "c-bolt-image__image-placeholder"
] %}

{% set lazyload_classes = [
  lazyload ? "c-bolt-image__lazyload",
  lazyload ? "c-bolt-image__lazyload--fade" : "",
  lazyload and is_jpg ? "c-bolt-image__lazyload--blur" : "",
  lazyload ? "js-lazyload" : ""
] %}

{% set image_attributes = create_attribute(image_attributes | default({})).addClass(image_classes, lazyload_classes)
  .setAttribute('alt', alt)
  .setAttribute( (lazyload ? "data-" : null) ~ "srcset", srcset ? srcset : null)
  .setAttribute( (lazyload ? "data-" : null) ~ "sizes", sizes)
  .setAttribute('src', lazyload ? ph_image : src)
%}

{% if zoom %}
  {% set image_attributes = image_attributes.setAttribute("data-zoom", src) %}
{% endif %}

{% set image_fallback_attributes = create_attribute({}).addClass(image_classes)
  .setAttribute('alt', alt)
  .setAttribute('src', src)
  .setAttribute(srcset ? "srcset" : "", srcset ? srcset : null)
%}

{% if cover %}
  {% set image_attributes = image_attributes.addClass("c-bolt-image--cover") %}
  {% set image_fallback_attributes = image_fallback_attributes.addClass("c-bolt-image--cover") %}
{% endif %}

{% set image_tag %}
  <img {{ image_attributes }} />

  {# Only output noscript fallback if lazyloading, and ratio will be output #}
  {% if lazyload %}
    <noscript> <img {{ image_fallback_attributes }} /> </noscript>
  {% endif %}
{% endset %}

{% set image_placeholder %}
  <img {{ image_attributes.removeClass(image_classes, lazyload_classes).addClass(placeholder_classes)
  .removeAttribute("data-srcset")
  .removeAttribute("src")
  .removeAttribute("data-sizes")
  .removeAttribute("srcset")
  .setAttribute("src", ph_image)
  }} />
{% endset %}

<bolt-image
  {% if slot %}slot="{{ slot }}"{% endif %}
  {% if src %}src="{{ src }}"{% endif %}
  {% if srcset %}srcset="{{ srcset }}"{% endif %}
  {% if alt %}alt="{{ alt }}"{% endif %}
  {% if sizes %}sizes="{{ sizes }}"{% endif %}
  {% if ratio %}ratio="{{ ratio }}"{% elseif not useAspectRatio %}ratio="none"{% elseif can_use_ratio %}ratio="{{ width }}:{{ height }}"{% endif %}
  {% if placeholder_color %}placeholder-color="{{ placeholder_color }}"{% endif %}
  {% if placeholder_image %}placeholder-image="{{ placeholder_image }}"{% endif %}
  {% if zoom %}zoom{% endif %}
  {% if cover %}cover{% endif %}
  {% if not lazyload %}no-lazy{% endif %}
  {% if can_use_placeholder and is_jpg %} style="background-color: {{ ph_color }};" {% endif %}
  >
  {% block image_content %}
    {% if can_use_ratio %}
      {% include "@bolt-components-ratio/ratio.twig" with {
        attributes: attributes,
        aspectRatioHeight: height * 1,
        aspectRatioWidth: width * 1,
        children: [
          is_jpg ? image_placeholder : "",
          image_tag,
        ] | join("")
      } only %}
    {% else %}
      {% if can_use_placeholder %}
        {{ image_placeholder}}
      {% endif %}
      {{ image_tag }}
    {% endif %}
  {% endblock %}
</bolt-image>
