
{#
  Bolt Image - Structure:
  - .c-bolt-image: uses the ratio object as a base if enabled
    - .c-bolt-image__img: lazyloaded img tag
    - .c-bolt-image__placeholder: lazyloader span while the img is lazyloaded.
#}

{#{% set srcset = srcset ? srcset : "" %}#}

{# Grabbing the data in the bolt manifest for this particular image #}
{% set imageDataBolt = bolt.data.images[src] %}

{# @todo DRY this #}
{% set imageSizes = [
  50, 100, 200, 320, 480, 640, 800, 1024, 1366, 1536, 1920, 2560, 2880
] %}


{#{% if placeholderImage is empty or placeholderColor is empty or srcset == "" %}#}
  {#{% set path = src|split('.' ~ ext)|first %}#}
{#{% endif %}#}

{#{% if path == "" and srcset == "" %}#}
  {#{% set srcset = src %}#}
{#{% endif %}#}

{% set imageDataTwig = getImageData(src)  %}
{#{% set imageData = imageDataBolt|merge(imageDataTwig) %}#}
{% set ext = src|split('.')|last %}


{% set placeholderImage = imageDataTwig.base64 %}
{% set placeholderColor = imageDataTwig.color %}
{% set height = imageDataTwig.height %}
{% set width = imageDataTwig.width %}

{% set ratio = ratio ?? true %}
{% set sizes = sizes | default("auto") %}
{% set zoom = zoom ?? false %}
{% set lazyload = lazyload ?? true %}


{# Get a whole number aspect ratio #}
{#@todo This mutation of ratio is not clear, refactor#}
{% if width > 0 and height > 0 and ratio == true %}
  {% set ratio = height / width * 100 ~ '%' %}
{% endif %}

{#{% set placeholderDummySrc = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" %}#}

{#{% set zoomSource = src %}#}

{#{% if srcset == "" and ext != "svg" %}#}
  {#{% for size in imageSizes if (size <= width) %}#}

    {#{% if size == width %}#}
      {#{% set srcset = srcset ~ path ~ '.' ~ ext ~ ' ' ~ size ~ 'w' ~ ', ' %}#}
      {#{% set zoomSource = path ~ '.' ~ ext %}#}
    {#{% else %}#}
      {#{% set srcset = srcset ~ path ~ '-' ~ size ~ '.' ~ ext ~ ' ' ~ size ~ 'w' ~ ', ' %}#}
      {#{% set zoomSource = path ~ '-' ~ size ~ '.' ~ ext %}#}
    {#{% endif %}#}

     {#store the current srcset path just in case this loop is our last -- loop.last var isn't available w/ conditions#}

  {#{% endfor %}#}
  {#{% set srcset = srcset|trim(', ') %}#}
{#{% elseif ext == "svg" %}#}
  {#{% set srcset = src %}#}
{#{% endif %}#}



{% if imageData %}
  {% set srcset = imageData.srcset %}
{% endif %}

{#--------------------#}
{# STOP!!!!!!!!!#}
{# The ONLY thing that can happen below here is creating and building the `attributes`, then calling the template - ALL data must be prepped by this point #}
{#--------------------#}

{% set attributes = create_attribute(attributes | default({})).addClass('c-bolt-image') %}

{% set imageAttributes = create_attribute(imageAttributes | default({})).addClass([
  "c-bolt-image__img",
  lazyload ? "js-lazyload" : "",
  lazyload ? "is-lazyloading" : ""
])
  .setAttribute('alt', alt)
  .setAttribute('src', src)
%}

{% if srcset %}
  {% set imageAttributes = imageAttributes.setAttribute("srcset", srcset) %}
{% endif %}

{#{% if zoom %}#}
  {#{% set imageAttributes = imageAttributes#}
    {#.setAttribute("data-zoom", zoomSource) %}#}
{#{% endif %}#}

{% set placeholderAttributes = create_attribute(placeholderAttributes | default({})).addClass("c-bolt-image__placeholder") %}
{% set styles = placeholderAttributes.getAttribute('style') | split(' ') | merge([
  placeholderColor ? "background-color: #{placeholderColor};" : "",
  placeholderImage ? "background-image: url(#{placeholderImage});" : ""
]) %}
{% set placeholderAttributes = placeholderAttributes.setAttribute('style', styles) %}

{#{% if lazyload %}#}
  {#{% set imageAttributes = imageAttributes#}
    {#.setAttribute("data-srcset", srcset)#}
    {#.setAttribute("srcset", placeholderDummySrc)#}
    {#.setAttribute("data-sizes", sizes) %}#}
{#{% endif %}#}

{% set imageTag %}
  <img {{ imageAttributes }}>
  <noscript>
    <img {{ imageAttributes.removeClass(["js-lazyload", "is-lazyloading"]) }}>
  </noscript>
{% endset %}

{% set imagePlaceholder %}
  <span {{ placeholderAttributes }}></span>
{% endset %}

{# Super helpful info if you uncomment #}
{{ console_log(_context) }}

<bolt-image>
  {% block image_content %}
    {% if width > 0 and height > 0 and ratio == true %}
      {% embed "@bolt/ratio.twig" with {
        attributes: attributes,
        aspectRatioHeight: height * 1,
        aspectRatioWidth: width * 1
      } %}
        {% block ratio_content %}
          {{ ext == "jpg" ? imagePlaceholder : "" }}
          {{ imageTag }}
        {% endblock %}
      {% endembed %}
    {% else %}
      {{ ext == "jpg" ? imagePlaceholder : "" }}
      {{ imageTag }}
    {% endif %}
  {% endblock %}
</bolt-image>
